<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="Yet Another DOMotic System">
    <meta name="author" content="yadoms team">

    <!-- Favicon, generated from https://realfavicongenerator.net -->
    <link rel="apple-touch-icon" sizes="180x180" href="img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon/favicon-16x16.png">
    <link rel="manifest" href="img/favicon/manifest.json">
    <link rel="mask-icon" href="img/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="img/favicon/favicon.ico">
    <meta name="msapplication-TileColor" content="#2b5797">
    <meta name="msapplication-TileImage" content="img/favicon/mstile-144x144.png">
    <meta name="msapplication-config" content="img/favicon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">

    <title>Yadoms</title>

    <!-- Bootstrap core CSS -->
    <link href="libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-non-responsive.css" rel="stylesheet">
    <!-- Custom styles for this template -->
    <link href="css/yadoms.css" rel="stylesheet">
    <link href="libs/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <link href="css/widget.css" rel="stylesheet">
</head>

<body>
    <!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="container">
            <div class="row" id="mainNavBar">
                <div class="col-md-12">
                    <div class="navbar-header">
                        <img src="img/icon_256.png" class="img-responsive pull-left application-logo" />
                        <a class="navbar-brand" href="#">Yadoms</a>
                    </div>
                    <div class="navbar-right">
                        <button href="#" class="btn btn-success pull-left customization-item hidden" id="btn-add-widget">
                            <i class="fa fa-puzzle-piece"></i>
                            <span data-i18n="mainPage.customization.addNewWidget"></span>
                        </button>
                        <ul class="nav navbar-nav">
                            <li>
                                <a href="#" class="" id="btn-show-dashboard" data-i18n="[title]mainPage.menu.dashboard">
                                    <i class="fa fa-cog"></i>
                                </a>
                            </li>
                            <li>
                                <a href="#" class="" id="customizeButton" data-i18n="[title]mainPage.menu.customization">
                                    <i class="fa fa-wrench"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="nav navbar-nav" id="pageMenu">
                        <ul class="nav nav-pills nav-justified page-tabs">
                            <!-- Nav pills of pages will be inserted here -->
                            <li class="customization-item hidden" id="btn-add-page">
                                <a>
                                    <span>&nbsp;</span>
                                    <div class="customizationToolbar pageCustomizationToolbar">
                                        <div class="customizationButton pageCustomizationButton" data-i18n="[title]mainPage.customization.addNewPage">
                                            <i class="fa fa-plus"></i>
                                        </div>
                                    </div>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!--/.nav-collapse -->
    </div>



    <div id="tabContainer" class="container">
        <div class="tab-content">
            <!-- widget grids tabs will be inserted here -->
        </div>
        <footer class="footer">
            <button class="btn btn-primary" id="btn-show-qrcode">
                <i class="fa fa-qrcode"></i>
            </button>
            <label id="copyrightLabel" class="label label-default">&copy; Yadoms 2016</label>
        </footer>
    </div>


    <div id="serverNotReady" class="server-not-ready text-center">
        <i class="fa fa-circle-o-notch fa-spin fa-3x fa-fw waiting-animation"></i>
        <p>
            <span data-i18n="initialization.loading">Yadoms is loading...</span>
        </p>
    </div>

    <div id="templates" class="hidden"></div>

    <script src="libs/bowser-1.3.0/js/bowser.min.js"></script>
    <script type="text/javascript">
        if (bowser.name === "Internet Explorer") {
            console.log("incompatible browser !");
            window.location.href = "browser.html";
        }
    </script>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="libs/jquery/js/jquery-2.2.4.min.js"></script>
    <!-- must be included before bootstrap -->
    <!-- the minimal needed for the boot-->
    <script src="libs/zlib/gunzip.min.js"></script>

    <script src="js/i18n-manager.js"></script>
    <script src="js/iso-language-codes.js"></script>
    <script src="js/rest-engine.js"></script>
    <script src="js/utility.js"></script>
    <script src="js/objects/configuration-manager.js"></script>
    <script src="js/objects/lazy-loader-manager.js"></script>
    <script type="text/javascript">
        
     //base configuration
     $.ajaxSetup({
         contentType: "application/json; charset=utf-8",
         scriptCharset: "utf-8",
         cache: true
     });

     $("#copyrightLabel").html("&copy; Yadoms " + new Date().getFullYear());

     var Yadoms = {
         modals: {},
         updateIntervalInOfflineMode: 10000,
         updateIntervalWithWebSocketDisabled: 1000,
         updateInterval: 5000,
         periodicDashboardTask: {},
         numberOfColumns: 12,
         gridWidth: 100,
         gridHeight: 100,
         gridMargin: 5,
         baseUrl: ''
     };

     var configurationManager = new ConfigurationManager();
     var i18nManagerInitialised = new $.Deferred();
     asyncLoadJSGzLibs(["libs/noty/js/packaged/jquery.noty.packaged.min.js.gz",
                        "libs/i18next/js/i18next.min.js.gz",
                        "libs/i18next/js/jquery-i18next.min.js.gz",
                        "libs/i18next/js/i18nextXHRBackend.min.js.gz"
                       ]).done(function () {
        i18nManagerInitialised = i18nManager.init();
     });
     
    /**
     * On page loaded
     */
    $(document).ready(function () {
        //load custom configuration from 'config.js', allow any js overriding
        asyncLoadJSLib("config.js")
            .always(function () {
                loadModals();
                i18nManagerInitialised.done(function () {
                   configurationManager.load().done(function() {
                       //we get install/firstStart key to have information if firstStart has already been done
                       if (!configurationManager.isServerFirstStart()) {
                           //we start app normally
                           main();
                       } else {
                           //we make the first start configuration
                           notifyInformation($.t(
                               "mainPage.actions.firstRunConfiguration"));

                           configurationManager.setServerFirstStartDone().save();
                           processFirstStart();
                        }
                     })
                     .fail(function (error) {
                        notifyError($.t("objects.ConfigurationManager.errorDuringGettingSystemConfiguration"), error);
                     });                        
                });
            });

        /**
         * Callback of the click on the show qr code button
         * Make lazy loading of the qrcode modal
         */
        $("#btn-show-qrcode").click(function () {
            Yadoms.modals.qrCode.loadAsync()
                .done(function () {
                    $('#qrcode-modal').modal({
                        backdrop: 'static'
                    });
                });
        });

        $("#btn-show-dashboard").click(function () {
            Yadoms.modals.mainDashboard.loadAsync()
                .done(function () {
                    $('#main-dashboard-modal').modal({
                        backdrop: 'static'
                    });
                    $('#main-dashboard-modal').off('hidden.bs.modal').on(
                        'hidden.bs.modal',
                        function () {
                            //clear the bootstrap validation when modal is hidden (handle submit and cancel behaviors)
                            $('#main-dashboard-modal').find(
                                "input,select,textarea").jqBootstrapValidation(
                                "destroy");

                            //we force the dashboard to display the summary refreshed page
                            $("#btn-dashboard-summary").click();
                        });
                });
        });

        /**
         * Callback of the click on the add page button
         * Make lazy loading of the add page modal
         */
        $("#btn-add-page").click(function () {
            createOrUpdatePage();
        });

        /**
         * Callback of the click on the add widget button
         * Make lazy loading of the add widget modal
         */
        $("#btn-add-widget").click(function () {
            Yadoms.modals.pickupController.loadAsync()
                .done(function () {
                    //search all plugin information
                    Yadoms.askPackages("widgets",
                        WidgetPackageManager,
                        "preview.png", // Name of thumbnail
                        "modals.add-widget.title",
                        createobject
                    );
                })
                .fail(function (error) {
                    notifyError($.t(
                        "objects.lazyLoaderManager.unableToLoadModal", {
                            modalPath: self.modalPath
                        }), error);
                });
        });

        function createobject(packageName, widgetType) {
            if (packageName) {
                //we get default size of the widget
                var minX = 1;
                var minY = 1;

                var pkg = widgetType.package;

                try {
                    minX = pkg.dimensions.min.x;
                    minY = pkg.dimensions.min.y;
                } catch (err) {}

                var maxX = Infinity;
                var maxY = Infinity;
                try {
                    maxX = pkg.dimensions.max.x;
                    maxY = pkg.dimensions.max.y;
                } catch (err) {}

                var defaultX = 1;
                var defaultY = 1;
                try {
                    defaultX = pkg.dimensions.default.x;
                    defaultY = pkg.dimensions.default.y;
                } catch (err) {}

                var sizeX = Math.min(maxX, Math.max(defaultX, minX));
                var sizeY = Math.min(maxY, Math.max(defaultY, minY));

                var currentPage = PageManager.getCurrentPage();
                assert(!isNullOrUndefined(currentPage), "A page must be selected");

                //we create a fake widget to display configuration form
                var newWidget = new Widget(-1, currentPage.id, packageName, "",
                    sizeX * Yadoms.gridWidth,
                    sizeY * Yadoms.gridHeight, 0, 0, "");

                newWidget.package = pkg;
                //we load configuration window only if the widget has a configuration
                if (!isNullOrUndefined(newWidget.package.configurationSchema)) {
                    Yadoms.modals.widgetConfiguration.loadAsync()
                        .done(function () {
                            Yadoms.configureWidget(newWidget, function () {
                                //if the configuration has been validated we can create the widget
                                createWidget(newWidget, currentPage);
                            });
                        });
                } else {
                    //we directly create the widget
                    createWidget(newWidget, currentPage);
                }
            }
        }

        function createWidget(newWidget, currentPage) {
            WidgetManager.createWidget(newWidget)
                .done(function (w) {
                    //we indicate taht the widget has never been placed on
                    w.position = 1000;
                    WidgetManager.loadWidget(w, currentPage, true)
                        .done(function () {
                            //we update the filter for the websocket
                            updateWidgetPolling(w)
                                .always(function () {
                                    updateWebSocketFilter();
                                    WidgetManager.updateWidgetLayout(w);
                                });
                        })
                        .fail(function (errorMessage) {
                            notifyError($.t(
                                "modals.add-widget.unableToCreateWidgetOfType", {
                                    "widgetType": newWidget.type
                                }), errorMessage);
                        });
                })
                .fail(function (errorMessage) {
                    notifyError($.t(
                        "modals.add-widget.unableToCreateWidgetOfType", {
                            "widgetType": newWidget.type
                        }), errorMessage);
                });
        }

        /**
         * Exit customization pressed esc key
         */
        $(document).keyup(function (e) {
            //escape key
            if (e.keyCode === 27) {
                if (customization) {
                    exitCustomization();
                }
            }
            return false;
        });
    });

     function loadModals() {
         Yadoms.modals.pickupController = new LazyLoaderManager("modals/pickup-controller.html");
         Yadoms.modals.widgetConfiguration = new LazyLoaderManager("modals/widget-configure.html");
         Yadoms.modals.widgetDelete = new LazyLoaderManager("modals/widget-delete.html");
         Yadoms.modals.pageDelete = new LazyLoaderManager("modals/page-delete.html");
         Yadoms.modals.pageConfigure = new LazyLoaderManager("modals/page-configure.html");
         Yadoms.modals.qrCode = new LazyLoaderManager("modals/qrcode.html");
         Yadoms.modals.mainDashboard = new LazyLoaderManager("modals/dashboard.html");
         Yadoms.modals.confirmation = new LazyLoaderManager("modals/confirmation.html");
         Yadoms.modals.pluginConfigure = new LazyLoaderManager("modals/plugin-configure.html");
         Yadoms.modals.pluginExtraQueriesConfigure = new LazyLoaderManager("modals/plugin-extra-queries-configure.html");
         Yadoms.modals.pluginShowLog = new LazyLoaderManager("modals/plugin-show-log.html");
         Yadoms.modals.deviceConfigure = new LazyLoaderManager("modals/device-configure.html");
         Yadoms.modals.keywordConfigure = new LazyLoaderManager("modals/keyword-configure.html");
         Yadoms.modals.keywordSetValue = new LazyLoaderManager("modals/keyword-set-value.html");
         Yadoms.modals.deviceAddManually = new LazyLoaderManager("modals/device-add-manually.html");
         Yadoms.modals.deviceConfigureManually = new LazyLoaderManager("modals/device-configure-manually.html");
         Yadoms.modals.virtualDeviceConfigure = new LazyLoaderManager("modals/virtual-device-configure.html");
         Yadoms.modals.deviceDelete = new LazyLoaderManager("modals/device-delete.html");
         Yadoms.modals.automationRuleNew = new LazyLoaderManager("modals/automation-rule-new.html");
         Yadoms.modals.automationRuleEdit = new LazyLoaderManager("modals/automation-rule-edit.html");
         Yadoms.modals.automationRuleShowLog = new LazyLoaderManager("modals/automation-rule-show-log.html");
         Yadoms.modals.recipientConfigure = new LazyLoaderManager("modals/recipient_configure.html");
         Yadoms.modals.showChangelog = new LazyLoaderManager("modals/show-changelog.html");
     }

     function processFirstStart() {
         //we check for page. If there is no page, we create a new one automatically
         PageManager.getAll()
             .done(function () {
                 if (PageManager.pages.length === 0) {
                     console.info("Creating a default page");
                     PageManager.createPage($.t("initialization.homePage"), 0)
                         .done(function () {
                             PageManager.ensureOnePageIsSelected();
                         });
                 }
                 //we can start app
                 main();
             })
             .fail(function (error) {
                 notifyError($.t("objects.pageManager.errorDuringGettingPages"), error);
             });
     }

     function waitForServerReady() {
         YadomsInformationManager.getList()
             .done(function (data) {
                 if (parseBool(data.serverReady) === true) {
                     whenServerReady();
                 } else {
                     window.setTimeout(function () {
                         waitForServerReady();
                     }, 500);
                 }
             })
             .fail(function (error) {
                 window.setTimeout(function () {
                     waitForServerReady();
                 }, 500);
             });
     }

     function whenServerReady() {
         $("#serverNotReady").hide();
         WebSocketEngine.initializeWebSocketEngine(function () {
             //web socket opened
             initializeWidgetEngine();
         });
     }

     function main() {
      //we set the right language
      i18next.changeLanguage(configurationManager.currentLanguage(), function () {
          var arrayOfDeffered = [];
          $("html").i18n();
          
          arrayOfDeffered.push(asyncLoadJSLibs(
          ["js/jquery-extensions.js",
           "js/objects/version.js",
           "js/objects/yadoms-information-manager.js",
           "js/objects/yadoms-time-manager.js",
           "js/objects/page.js",
           "js/objects/widget.js",
           "js/objects/widget-package.js",
           "js/objects/page-manager.js",
           "js/objects/plugin-instance.js",
           "js/objects/plugin-instance-manager.js",
           "js/objects/device.js",
           "js/objects/device-manager.js",
           "js/objects/encryption-manager.js",
           "js/objects/widget-manager.js",
           "js/objects/widget-package-manager.js",
           "js/objects/keyword.js",
           "js/objects/keyword-manager.js",
           "js/objects/acquisition.js",
           "js/objects/time.js",
           "js/objects/acquisition-manager.js",
           "js/objects/plugin.js",
           "js/objects/plugin-manager.js",
           "js/objects/task.js",
           "js/objects/task-manager.js",
           "js/objects/unit-adapter.js",
           "js/objects/configuration/configuration-helper.js",
           "js/objects/event-logger-manager.js",
           "js/objects/session-data-manager.js",
           "js/websocket-engine.js",
           "js/widget-engine.js",
           "js/widget-customization.js",
           "js/objects/date-time.js",
           "js/objects/widget-api.js"
          ]));

          arrayOfDeffered.push(asyncLoadManyGzCss(
                               ["libs/jquery-ui/css/jquery-ui.min.css.gz",
                                "libs/bootstrap-toggle/css/bootstrap2-toggle.min.css.gz"]));
          
          arrayOfDeffered.push(asyncLoadJSGzLibs(
                          ["libs/moment.js/js/moment-with-langs.min.js.gz",
                           "libs/jquery-ui/js/jquery-ui.min.js.gz",
                           "libs/bootstrap/js/bootstrap.min.js.gz",
                           "libs/knockout/js/knockout-3.4.0.js.gz",
                           "libs/jqBootstrapValidation/js/jqBootstrapValidation.min.js.gz",
                           "libs/bootstrap-toggle/js/bootstrap2-toggle.min.js.gz",
                           "libs/jquery-MD5/js/jquery.md5.min.js.gz",
                           "libs/packery/packery.pkgd.min.js.gz",
                           "libs/lodash/lodash.min.js.gz"]));
             
             $.when.apply($,arrayOfDeffered).done(function() {
                var arrayOfDef = [];
                console.log("0");
                arrayOfDef.push(asyncLoadJSGzLib("libs/moment.js/js/moment-timezone.min.js.gz"));
                arrayOfDef.push(asyncLoadManyGzCss(["libs/jquery-ui/css/jquery-ui.min.css.gz",
                                                    "libs/bootstrap-toggle/css/bootstrap2-toggle.min.css.gz"]));
                arrayOfDef.push(asyncLoadJSLib("js/knock-out-extenders.js"));
                   
                $.when.apply($,arrayOfDef).done(function() {
                   //load after libraries with dependancies
                   asyncLoadJSGzLibs(["libs/moment.js/js/moment-timezone-data.min.js.gz",
                                      "libs/jquery-ui-touch-punch/jquery.ui.touch-punch.min.js.gz"]);
                                      
                   moment.lang(configurationManager.currentLanguage());

                   //Load Plugin instances to load initially all languages files. Needed for some widgets
                   PluginInstanceManager.getAll().done(function (allInstances) {
                       waitForServerReady();
                   })
                   .fail(function(error){
                      console.log(error);
                   });
                });
             })
             .fail(function(error){
                console.log(error);
             });
          });
        }
    </script>
</body>
</html>