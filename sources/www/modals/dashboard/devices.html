<div id="dashboard-devices">
   <h1 class="page-header"><span class="fa fa-tasks"></span>&nbsp;<span data-i18n="modals.dashboard.sub-windows.devices.title"></span></h1>
   <span data-i18n="modals.dashboard.sub-windows.devices.deviceListDescription"></span><br>
   <button id="btn-add-new-device" type="button" class="btn btn-success dashboard-btn-new"><span class="fa fa-tasks"></span>&nbsp;&nbsp;<span data-i18n="modals.dashboard.sub-windows.devices.new"></span></button>
   <table id="device-list" class="table table-bordered table-striped dashboard-list">
      <tr>
         <td data-i18n="modals.dashboard.sub-windows.devices.table.name" class="col-md-2"></td>
         <td data-i18n="modals.dashboard.sub-windows.devices.table.attachedTo" class="col-md-2"></td>
         <td data-i18n="modals.dashboard.sub-windows.devices.table.model" class="long-text col-md-2"></td>
         <td data-i18n="modals.dashboard.sub-windows.devices.table.actions" class="col-md-2"></td>
      </tr>
      <!-- devices will be listed here-->
   </table>
   
   
  <label>
    <input class="cb-showblacklist" type="checkbox">
    <span data-i18n="modals.dashboard.sub-windows.devices.showBlacklistedDevices"></span>
  </label>   
</div>

<script>
   var deviceList = [];
   var actionsBtns =   "<div class=\"btn-group\">\n" +
                       "<button type=\"button\" class=\"btn btn-primary btn-configure\" data-i18n=\"[title]modals.dashboard.sub-windows.devices.configure\"><span class=\"fa fa-cog\"></span></button>\n" +
                       "<button type=\"button\" class=\"btn btn-danger btn-delete\" data-i18n=\"[title]modals.dashboard.sub-windows.devices.delete\"><span class=\"fa fa-trash\"></span></button>\n" +
                       "</div>";

   var actionsBtnsBlacklist = "<div class=\"btn-group\">\n" +
                              "<button type=\"button\" class=\"btn btn-success btn-restore\" data-i18n=\"[title]modals.dashboard.sub-windows.devices.restore\"><span class=\"fa fa-reply\"></span></button>\n" +
                              "<button type=\"button\" class=\"btn btn-danger btn-delete\" data-i18n=\"[title]modals.dashboard.sub-windows.devices.delete\"><span class=\"fa fa-trash\"></span></button>\n" +
                              "</div>";   
   
   dispatchkeywordsToDevicesView = function (acquisition) {
      var $keywordRow = getKeywordIdDomRow(acquisition.keywordId);
      if ($keywordRow.length !=0) {
         var device;
         var $deviceDetailsTable = $("table#keyword-list");
         if ($deviceDetailsTable.length === 1) {
            device = getDeviceFromId($deviceDetailsTable.attr("device-id"));
         }
         if (!isNullOrUndefined(device)){
            var index = device.keywords.map(function (e) { return e.id; }).indexOf(acquisition.keywordId);
            if (index != -1)
               updateKeywordDomLine($keywordRow, acquisition, device.keywords[index], device.attachedPlugin);
         }
      }      
   };
   
   dispatchkeywordNewToDevicesView = function (keyword) {
      var i = deviceList.map(function (e) { return e.id; }).indexOf(keyword.keyword.deviceId);
      var device;
      if (i !== -1 && !isNullOrUndefined(deviceList[i].keywords)){
         deviceList[i].keywords.push(keyword.keyword);
         device = deviceList[i];
      
         // sort keywords
         deviceList[i].keywords = sortListItemsWithFriendlyName (deviceList[i].keywords);
         var $deviceRow = getDeviceDomRow(device);

         if ($deviceRow.length !=0) {
            if ($("table#keyword-list").length!= 0) { // If the table exist, we clean up the table
               //we remove all rows except header
               $("table#keyword-list").find("tr:gt(0)").remove();
            } else { 
               $("p.nokeyword-for-device").remove();
               // create the table
               createKeywordsTable(device, $deviceRow);
            }
            fillTable(device);
            AcquisitionManager.getLastValues(device.keywords)
            .done(function (data) {
               var keywordIds = [];
               $.each(data, function (index, acquisition) {
                  $.each(device.keywords, function (idx, keyword) {
                     if (keyword.id === acquisition.keywordId) {
                        var $keywordRow = getKeywordDomRow(keyword);
                        if (!$keywordRow) {
                           $keywordRow = createKeywordDomLine($deviceDetailsTable, keyword);
                        }
                        keywordIds.push(keyword.id);
                        updateKeywordDomLine($keywordRow, acquisition, keyword, device.attachedPlugin);
                     } else {
                        return; //break $.each
                     }
                  });
               });
               
               //subscribe new keywords for display
               updateWebSocketFilter(keywordIds);
            })
            .fail(function (error) {
               notifyError($.t("objects.generic.errorGetting", { objectName: "last acquisition for device = " + device.id }), error);
            });               
         }
      }
   };
   
   dispatchkeywordDeletedToDevicesView = function (keyword) {
      getKeywordIdDomRow(keyword.keyword.id).remove();
      // Remove the keyword from the keyword list of the specific device
      var i = deviceList.map(function (e) { return e.id; }).indexOf(keyword.keyword.deviceId);
      if (i !== -1){
         if (!isNullOrUndefined(deviceList[i].keywords)){
            var keywordCell = deviceList[i].keywords.map(function (e) { return e.id; }).indexOf(keyword.keyword.id);
            
            if (keywordCell !== -1){
               deviceList[i].keywords.splice(keywordCell, 1);
            }
            
            var keywords = [];
            $.each(deviceList[i].keywords, function (idx, keyword) {
               keywords.push(keyword.id);
            });
            
            // update the new query to the server
            updateWebSocketFilter(keywords);
         }
      }
   };
   
   dispatchDevicesNewToDevicesView = function (device) {
      var indexToInsert = 0;
      //Insert into the tab
      $.each(deviceList, function (index, element) {
         var $deviceRow = getDeviceDomRow(element);
         var $span = $deviceRow.find("td.device-friendlyName").find("span");
         
         if ($span.length != 0){
            var friendlyName = $span[1].innerText;
            if (device.device.friendlyName > friendlyName){
               indexToInsert = index + 1;
            }
         }
      });
      DeviceManager.getAttachedPlugin(device.device, true)
      .done(function () {
         addDeviceToDom(device.device, indexToInsert);
         deviceList.push(device.device);
         deviceList = sortListItemsWithFriendlyName ( deviceList );
      });
   };   
   
   dispatchDevicesBlacklistedToDevicesView = function (device) {
      var showblacklistedDevices = $("input.cb-showblacklist").prop("checked");
      
      if (!showblacklistedDevices) {
         dispatchDevicesDeletedToDevicesView(device);
      }else { // display the device with correct icons
         transformDeviceInDom(device.device);
      }
   };
   
   dispatchDevicesDeletedToDevicesView = function (device) {
      // remove device and device-details if any ...
      $("table#device-list").find("tr[device-id='" + device.device.id + "']").remove();
      
      // Remove the device from the device list to display
      var i = deviceList.map(function (e) { return e.id; }).indexOf(device.device.id);
      if (i !== -1){
         deviceList.splice(i, 1);
         // update the new query to the server
         updateWebSocketFilter();
      }    
   };
   
   function transformDeviceInDom(device) {
      // remove device details if any 
      getDeviceDetailsDomRow().remove();
      
      var $deviceRow = $("table#device-list").find("tr[device-id='" + device.id + "'].device");
      $deviceRow.find("td.device-friendlyName").find("span").remove();
      
      var fn = device.friendlyName;
      if(parseBool(device.blacklist)==true)
         fn = "<del>"+device.friendlyName+"</del>";
           
      var friendlyName = "<span class=\"glyphicon glyphicon-chevron-down deploy\">&nbsp;</span><span>" + fn + "</span>";
      
      // display the new name
      $deviceRow.find("td.device-friendlyName").append(friendlyName);
      
      //we remove old buttons
      $deviceRow.find("td.device-actions").find(".btn-group").remove();
      
      //we add new actions to the device
      if(parseBool(device.blacklist) == true) {
         $deviceRow.find("td.device-actions").append(actionsBtnsBlacklist);
      } else {
         if((device.name != "pluginState" && device.model != "Plugin state")) 
           $deviceRow.find("td.device-actions").append(actionsBtns);
      }
      addDeviceButtonsEvents($deviceRow, device);  
   };
   
   Yadoms.initializeDeviceDashboard = function () {
      $("input.cb-showblacklist").off('change').on('change', function (){ 
         refreshDeviceList();
      });
      
      Yadoms.DeviceDashboardRegisterButtonAddNewDevice();
      
      $("table#device-list").on("remove", function () {
         //subscribe only the page, no extra device at the remove of this page
         updateWebSocketFilter();         
      });
      
      var d = new $.Deferred();
      var arrayOfDeffered = [];
      
      arrayOfDeffered.push(asyncLoadJSLib("js/json-prettyprint.js"));
      arrayOfDeffered.push(refreshDeviceList());
      
      $.when.apply($, arrayOfDeffered)
      .done(d.resolve)
      .fail(d.reject)
      
      // refresh the device list
      return d.promise();
   };
   
   Yadoms.DeviceDashboardRegisterButtonAddNewDevice = function () {
      $("#btn-add-new-device").one("click", function () {addNewDevice();});
   };

   function refreshDeviceList() {
      var d = new $.Deferred();
      var showblacklistedDevices = $("input.cb-showblacklist").prop("checked");

      //we remove all rows except header
      $("table#device-list").find("tr:gt(0)").remove();

      //we clear pluginInstance array
      var tempList = [];
      var arrayOfDeffered = [];
      var isDeveloperMode = false;
      
      var deffered2 = YadomsInformationManager.getList();
      arrayOfDeffered.push(deffered2);
      deffered2.done(function (data) {
         isDeveloperMode = data.developerMode;
      });      
      
      var deffered1 = DeviceManager.getAll();
      arrayOfDeffered.push(deffered1);
      deffered1.done(function (allDevices) {
         tempList = sortListItemsWithFriendlyName (allDevices);
         var deffered3 = DeviceManager.getAttachedPlugins(tempList);
         arrayOfDeffered.push(deffered3);
         
         // The "when.apply" is here to wait the deffered3
         $.when.apply($, arrayOfDeffered).done(function () {
            //foreach result we append a <tr>
            $.each(tempList, function (index, value) {
               if( (!isDeveloperMode && (value.name !== "pluginState" || value.model !== "Plugin state")) || isDeveloperMode) {
                  if(showblacklistedDevices || (!showblacklistedDevices && parseBool(value.blacklist) === false)) {
                     addDeviceToDom(value, null);
                     deviceList.push(value);
                  }
               }
            });
            d.resolve();
         })
         .fail(function (error) {
            notifyError($.t("widgets.chart:errorDuringGettingDeviceData"), error);
            d.reject();
         });         
      });
      
      return d.promise();
   }

   function getDeviceDomRow(device) {
      return $("table#device-list").find("tr[device-id='" + device.id + "'].device");
   }

   function getDeviceDetailsDomRow() {
      return $("table#device-list").find("tr.device-details");
   }

   function getKeywordDomRow(keyword) {
      return getKeywordIdDomRow(keyword.id);
   }
   function getKeywordIdDomRow(keywordId) {
      return $("table#keyword-list").find("tr[keyword-id='" + keywordId + "']");
   }

   //Get the Device in the deviceList array searching by its id
   function getDeviceFromId(id) {
      var i = deviceList.map(function (e) { return e.id; }).indexOf(id);
      if (i !== -1)
         return deviceList[i];
      return undefined;
   }
   
   function addDeviceButtonsEvents(deviceRow, device) {
      //we bind event on the different actions
      deviceRow.find("button.btn-configure").off().one('click', function (e) { 
         e.stopPropagation();       
         updateDeviceConfiguration(device);
      });

      deviceRow.find("button.btn-delete").off().one('click', function (e) {
         e.stopPropagation();
         deleteDevice(device);
      });

      deviceRow.find("button.btn-restore").off().one('click', function (e) { 
         e.stopPropagation();
         restoreDevice(device);           
      });      
   };
   
   function addDeviceToDom(device, positionDevice) {
      //in case the device is blacklisted, then strike it
      var fn = device.friendlyName;
      if(parseBool(device.blacklist)===true)
         fn = "<del>"+device.friendlyName+"</del>";
              
      var friendlyName = "<span class=\"glyphicon glyphicon-chevron-down deploy\">&nbsp;</span><span>" + fn + "</span>";
      var model = "<span>" + device.model + "</span>";

      //we add it to the DOM
      var $deviceList = $("table#device-list");
	   var frameworkDevice = "<tr device-id=\"" + device.id + "\" class=\"device\"><td class=\"device-friendlyName vert-align text-left\"></td><td class=\"device-attachedTo vert-align\"></td><td class=\"device-model vert-align\"></td><td class=\"device-actions vert-align\"></td></tr>";

	   if ( positionDevice == null || deviceList.length == 0 )
         $deviceList.append( frameworkDevice );
	   else{
	     var $row = null;
        $row = getDeviceDomRow(deviceList[positionDevice]);
        $(frameworkDevice).insertBefore($row);
	   }

      var $deviceRow = getDeviceDomRow(device);
      //we fill the data
      $deviceRow.find("td.device-friendlyName").html(friendlyName);
      $deviceRow.find("td.device-model").html(model);

      //we add actions to the device
      if(parseBool(device.blacklist) === true) {
         $deviceRow.find("td.device-actions").append(actionsBtnsBlacklist);
      } else {
         if((device.name != "pluginState" && device.model != "Plugin state")) 
           $deviceRow.find("td.device-actions").append(actionsBtns);
      }
     
      addDeviceButtonsEvents($deviceRow, device);
      $deviceRow.one('click', function () { clickDevice(device); });
      $deviceRow.i18n();

      var iconName;
      if (!device.attachedPlugin.isSystemCategory()) {
         iconName = "plugins/" + device.attachedPlugin.type + "/icon.png";
         
         //disable it before async update
         $deviceRow.find("button.btn-configure").prop('disabled', true);
         PluginInstanceManager.getState(device.attachedPlugin)
         .done(function(instanceState) {
            if (instanceState.state !== "Stopped" && instanceState.state !== "Error" && instanceState.state) {
               $deviceRow.find("button.btn-configure").prop('disabled', false);
            }
         });
      }
      else {
         //we use application logo
         iconName = "img/icon_256.png";
         
         // The system plugin contains hard-coded devices (ie device containing shutdown and reboot keywords) and virtual devices
         // Only virtual devices are configurable/removable
         if (device.type !== "virtualDeviceType") {
            $deviceRow.find("button.btn-configure").addClass("hide");
            $deviceRow.find("button.btn-configure").off('click');
            $deviceRow.find("button.btn-delete").addClass("hide");
            $deviceRow.find("button.btn-delete").off('click');
         }
      }

      var attachedTo = "<img src=\"" + iconName + "\" class=\"img-thumbnail dashboard-table-icon\">&nbsp;&nbsp;" +
              "<span>" + device.attachedPlugin.displayName + "</span>";

      $deviceRow.find("td.device-attachedTo").html(attachedTo);
   }
   
   function recordNewDeviceConfiguration(device) {
      var d = new $.Deferred();
      
      DeviceManager.updateToServer(device)
      .done(function (updateDevice) {
            //We update the information that can have changed after the configuration
            var i = deviceList.map(function (e) { return e.id; }).indexOf(updateDevice.Id);
            
            if (i !== -1){ // The device exist !
               var $row = getDeviceDomRow(updateDevice);
               if (deviceList[i].friendlyName === updateDevice.friendlyName && updateDevice.model === deviceList[i].model) {
                  var friendlyName = "<span class=\"glyphicon glyphicon-chevron-down deploy\">&nbsp;</span><span>" + device.friendlyName + "</span>";
                  $row.find("td.device-friendlyName").html(friendlyName);
                  var model = "<span>" + device.model + "</span>"
                  $row.find("td.device-model").html(model);               
               }else {
                  DeviceManager.getAttachedPlugin(device, true)
                  .done(function () {
                     $row.remove ();
                     addDeviceToDom ( device, deviceList.indexOf (updateDevice) );
                     deviceList[i] = updateDevice;
                     //sort after rename
                     deviceList = sortListItemsWithFriendlyName ( deviceList );                  
                  });
               }
            }
            d.resolve();
      })                        
      .fail(function (error) {
          notifyError($.t("objects.deviceManager.errorUpdating", { deviceName: device.friendlyName }), error);
          d.reject();
      });
      return d.promise();
   }

   function updateDeviceConfiguration(device) {
      if (PluginInstanceManager.isSystemCategory(device.attachedPlugin)) {
         // Virtual device
         Yadoms.modals.virtualDeviceConfigure.loadAsync()
         .done(function () {
             Yadoms.showVirtualDeviceConfigurationModal(device, false, function (friendlyName, model, configuration) {
               device.friendlyName = friendlyName;
               device.model = model;
               device.configuration = configuration;
               recordNewDeviceConfiguration(device);
               
               var $deviceRow = getDeviceDomRow(device);
               addDeviceButtonsEvents($deviceRow, device);
            });
         });
      } else {
         // Manually plugin-related device creation
         //device represents the device concerned
         //we just ask for the friendly name
         Yadoms.modals.deviceConfigure.loadAsync()
            .done(function () {
               DeviceManager.getConfigurationSchema(device)
               .done(function(schemaConfig) {
                  Yadoms.showConfigurationDeviceModal(device, schemaConfig, function () {
                     recordNewDeviceConfiguration(device)
                     .done(function() {
                        // get the keyword list for equipments : some equipments change dynamically the keyword list.
                        var i = deviceList.map(function (e) { return e.id; }).indexOf(device.id);
                        if (i !== -1){
                           deviceList[i] = device; // update the device
                        }
                     });
                     
                     var $deviceRow = getDeviceDomRow(device);
                     addDeviceButtonsEvents($deviceRow, device);
                  });
               })
               .fail(function (error) {
                  notifyError($.t("objects.deviceManager.errorUpdating", { deviceName: device.friendlyName }), error);
                  var $deviceRow = getDeviceDomRow(device);
                  addDeviceButtonsEvents($deviceRow, device);
               });
            });
      }
   }
   
   function createKeywordsTable(device, deviceRow) {
      var selectedClass = "info";
   
      //we create device details table
      deviceRow.after("<tr device-id=\"" + device.id + "\" class=\"device-details " + selectedClass + "\"><td colspan=\"4\">" +
               "<table id=\"keyword-list\" device-id=\"" + device.id + "\" class=\"table table-bordered table-striped\">" +
               "<tr>" +
                  "<td data-i18n=\"modals.dashboard.sub-windows.devices.details.table.name\" class=\"col-md-2\"></td>" +
                  "<td data-i18n=\"modals.dashboard.sub-windows.devices.details.table.value\" class=\"col-md-2\"></td>" +
                  "<td data-i18n=\"modals.dashboard.sub-windows.devices.details.table.units\" class=\"col-md-2\"></td>" +
                  "<td data-i18n=\"modals.dashboard.sub-windows.devices.details.table.update\" class=\"col-md-2\"></td>" +
                  "<td data-i18n=\"modals.dashboard.sub-windows.devices.details.table.actions\" class=\"col-md-2\"></td>" +
               "</tr>" +
               "<!-- keywords will be listed here-->" +
               "</table>" +
               "</td></tr>");   
   };
   
   function fillTable(device) {
      var $deviceDetailsTable = $("table#keyword-list");
      $deviceDetailsTable.i18n();

      var actionsBtns = "<div class=\"btn-group\">\n" +
               "<button type=\"button\" class=\"btn btn-primary btn-configure\" data-i18n=\"[title]modals.dashboard.sub-windows.devices.configure\"><span class=\"fa fa-pencil\"></span></button>\n" +
               "</div>";

      var actionsBtnsWithEdit = "<div class=\"btn-group\">\n" +
               "<button type=\"button\" class=\"btn btn-primary btn-configure\" data-i18n=\"[title]modals.dashboard.sub-windows.devices.configure\"><span class=\"fa fa-pencil\"></span></button>\n" +
               "<button type=\"button\" class=\"btn btn-success btn-setvalue\" data-i18n=\"[title]modals.dashboard.sub-windows.devices.setvalue\"><span class=\"fa fa-sign-in\"></span></button>\n" +
               "</div>";
   
      var deviceList = device.keywords;
      deviceList = sortListItemsWithFriendlyName ( deviceList );
      
      $.each(deviceList, function (index, keyword) {
         $deviceDetailsTable.append("<tr keyword-id=\"" + keyword.id + "\"><td class=\"keyword-friendlyName vert-align\"></td><td class=\"keyword-value vert-align\"><td class=\"keyword-units vert-align\"><td class=\"keyword-update vert-align\"></td><td class=\"keyword-actions vert-align\"></td></tr>");

         var $keywordRow = getKeywordDomRow(keyword);
         var fn = keyword.friendlyName;
         
         if(parseBool(keyword.blacklist)===true)
            fn = "<del>"+keyword.friendlyName+"</del>";
         var friendlyName = "<span>" + fn + "</span>";
         var units = "<span>" + $.t(keyword.units) + "</span>";

         $keywordRow.find("td.keyword-friendlyName").html(friendlyName);
         $keywordRow.find("td.keyword-units").html(units);

         //we add actions to the keyword
         if (keyword.accessMode && keyword.accessMode.toLowerCase() === "getset" && keyword.capacityName) {
            $keywordRow.find("td.keyword-actions").append(actionsBtnsWithEdit);
         } else {
            $keywordRow.find("td.keyword-actions").append(actionsBtns);
         }
         
         //we prevent from renaming keywords on system devices
         if ((!isNullOrUndefined(device.attachedPlugin)) && (device.attachedPlugin.isSystemCategory())) {
            $keywordRow.find("button.btn-configure").addClass("hide");
         }
         else if (device.name == "pluginState" || device.model == "Plugin state") {
            $keywordRow.find("button.btn-configure").addClass("hide");
         }
         else {
            //we bind event on the different actions
            $keywordRow.find("button.btn-configure").one('click', function () { configureKeyword(keyword); });
         }

         YadomsDevicesActivateButtonSetKeywordValue(device, keyword);
         /*if ($keywordRow.find("button.btn-setvalue")) {
            $keywordRow.find("button.btn-setvalue").one('click', function () { setKeywordValue(keyword, device); });
         }*/
      });
   };
   
   function YadomsDevicesActivateButtonSetKeywordValue(device, keyword){
      var $keywordRow = getKeywordDomRow(keyword);
      $keywordRow.find("button.btn-setvalue").one('click', function () { setKeywordValue(keyword, device); });
   }

   function clickDevice(device) {
      //device represent the device concerned
      var $deviceRow = getDeviceDomRow(device);
      var selectedClass = "info";

      //we remove the line that contains keywords information
      var $details = getDeviceDetailsDomRow();
      if (!isNullOrUndefinedOrEmpty($details))
         $details.remove();

      $(".nokeyword-for-device").remove();
      
      //we look if this device is already selected
      if (!$deviceRow.hasClass(selectedClass)) {
         PluginInstanceManager.downloadPackage(device.attachedPlugin)
         .done(function() {
            DeviceManager.getKeywords(device)
            .done(function () {
               $deviceRow.siblings(".device").find("span.deploy").removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down");
               //we select the line
               $deviceRow.find("span.deploy").removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up");
               $deviceRow.addClass(selectedClass).siblings(".device").removeClass(selectedClass);

               if(device.keywords && device.keywords.length > 0) {
                  //we create device details table
                  createKeywordsTable(device, $deviceRow);
                  fillTable(device);
                  
                  // update immediately informations
                  AcquisitionManager.getLastValues(device.keywords)
                  .done(function (data) {
                     var keywordIds = [];
                     $.each(data, function (index, acquisition) {
                        $.each(device.keywords, function (idx, keyword) {
                           if (keyword.id === acquisition.keywordId) {
                              var $keywordRow = getKeywordDomRow(keyword);
                              if (!$keywordRow) {
                                 $keywordRow = createKeywordDomLine($deviceDetailsTable, keyword);
                              }
                              keywordIds.push(keyword.id);
                              updateKeywordDomLine($keywordRow, acquisition, keyword, device.attachedPlugin);
                           } else {
                              return; //break $.each
                           }
                        });
                     });
                     
                     //subscribe new keywords for display
                     updateWebSocketFilter(keywordIds);
                  })
                  .fail(function (error) {
                     notifyError($.t("objects.generic.errorGetting", { objectName: "last acquisition for device = " + device.id }), error);
                  });
               } else {
                  $deviceRow.after('<p class="nokeyword-for-device" data-i18n="modals.dashboard.sub-windows.devices.details.nokeywords">Aucun keyword associé</p>');
                  $(".nokeyword-for-device").i18n();
               }
               
               //Activate a new time the possibility to collapse the keyword list
               $deviceRow.one('click', function () { clickDevice(device); });
            });
         });
      }
      else {
         $deviceRow.removeClass(selectedClass);
         $deviceRow.find("span.deploy").removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down");
         
         // Remove extra keywords to query from the server
         updateWebSocketFilter();
         
         //Activate the possibility to expand the device
         $deviceRow.one('click', function () { clickDevice(device); });
      }
   }

   function deleteDevice(device) {
      if(parseBool(device.blacklist)===true){
         Yadoms.modals.confirmation.loadAsync()
         .done(function () {
            Yadoms.showConfirmModal(Yadoms.btnKind.confirmCancel, $.t("modals.confirm-delete-device.title"), $.t("modals.confirm-delete-device.text", { deviceName: device.friendlyName }), function () {
               DeviceManager.deleteDevice(device, true)
               .fail(function (error) {
                  notifyError($.t("modals.dashboard.sub-windows.devices.errorDeletingDevice", { device: device.friendlyName }), error);
               });
            });
         });
      } else {
         Yadoms.modals.deviceDelete.loadAsync()
         .done(function () {
            Yadoms.showDeleteDeviceModal(device, function (deleteDevice) {
               DeviceManager.deleteDevice(device, deleteDevice)
               .fail(function (error) {
                  notifyError($.t("modals.dashboard.sub-windows.devices.errorDeletingDevice", { device: device.friendlyName }), error);
               });
            });
         });   
      }
   }

   function restoreDevice(device) {
      //device represent the device concerned
      DeviceManager.restoreDevice(device)
      .done(function () {
         // The refresh device list refresh devices & keywords
         refreshDeviceList();
      })
      .fail(function (error) {
         notifyError($.t("modals.dashboard.sub-windows.devices.errorDeletingDevice", { device: device.friendlyName }), error);
      });
   }

   function configureKeyword(keyword) {
      //keyword represent the device concerned
      //we just ask for the friendly name
      Yadoms.modals.keywordConfigure.loadAsync()
      .done(function () {
         Yadoms.showConfigurationKeywordModal(keyword, function () {
            KeywordManager.updateToServer(keyword)
            .done(function () {
               //We update the information that can have changed after the configuration
               var $row = getKeywordDomRow(keyword);
               $row.find("td.keyword-friendlyName").html(keyword.friendlyName);
            })
            .fail(function (error) {
               notifyError($.t("modals.dashboard.sub-windows.devices.errorUpdatingKeyword", { keyword: keyword.friendlyName }), error);
            });
         });
      });
   }

   function setKeywordValue(keyword, device) {
      var $keywordRow = getKeywordDomRow(keyword);
      var value = null;
      
      var $tdvalue = $keywordRow.find("td.keyword-value");
      if(keyword.type.toLowerCase() === "bool") {
         var $checkbox = $tdvalue.find("input");
         if($checkbox)
            value = $checkbox.is(":checked");
         else
            value = false;
      } else {      
         value = $tdvalue.find("span").html();
      }
      
      if (keyword.capacityName.toLowerCase() === "event"){
         KeywordManager.sendCommand(keyword.id, '1');
      } else {
         Yadoms.modals.keywordSetValue.loadAsync()
         .done(function () {
            Yadoms.showSetKeywordValueModal(keyword, keyword.measure.toLowerCase() === "increment" ? 0 : value, device)
            .done(function (keyword, newValue) {
               KeywordManager.sendCommand(keyword.id, newValue.toString());
            })
            .fail(function () {
             //cancelled
            });
         });
      }
   }

   function addNewDevice() {
      Yadoms.modals.deviceAddManually.loadAsync()
      .done(function () {
         Yadoms.askPluginTypesForManuallyDeviceCreation(function (pi) {
            if (PluginInstanceManager.isSystemCategory(pi)) {
               // Virtual device creation
               Yadoms.modals.virtualDeviceConfigure.loadAsync()
               .done(function () {
                   Yadoms.showVirtualDeviceConfigurationModal(null, true, function (newDeviceName, newDeviceModel, newDeviceConfiguration) {
                     PluginInstanceManager.createManuallyDevice(pi, newDeviceName, newDeviceModel, "virtualDeviceType", newDeviceConfiguration)
                     .fail(function (error) {
                        notifyError($.t("objects.pluginInstance.errorCreatingManuallyDevice", { deviceName: newDeviceName }), error);
                     });
                  });
               });
            } else {
               // Manually plugin-related device creation
               //we get package.json
               var arrayOfDeffered = [];
               arrayOfDeffered.push(PluginInstanceManager.downloadPackage(pi));
               arrayOfDeffered.push(Yadoms.modals.deviceConfigureManually.loadAsync());
               
               $.when.apply($, arrayOfDeffered).done(function () {
                  //we launch configureInstance GUI
                   Yadoms.showConfigurationManuallyDeviceModal(pi, function (newDeviceName, newDeviceModel, newDeviceType, newDeviceConfiguration) {
                       //we ask for manually device creation
                     PluginInstanceManager.createManuallyDevice(pi, newDeviceName, newDeviceModel, newDeviceType, newDeviceConfiguration)
                     .fail(function (error) {
                        notifyError($.t("objects.pluginInstance.errorCreatingManuallyDevice", { deviceName: newDeviceName }), error);
                     });
                  });
               });
            }
         });         
      });
   }

   function createKeywordDomLine($deviceDetailsTable, keyword) {
      $deviceDetailsTable.append("<tr keyword-id=\"" + keyword.id + "\"><td class=\"keyword-friendlyName vert-align\"></td><td class=\"keyword-value vert-align\"><td class=\"keyword-units vert-align\"><td class=\"keyword-update vert-align\"></td><td class=\"keyword-actions vert-align\"></td></tr>");
      var $keywordRow = getKeywordDomRow(keyword);

      //we fill the data
      var friendlyName = "<span>" + keyword.friendlyName + "</span>";
      var units = "<span>" + $.t(keyword.units) + "</span>";

      $keywordRow.find("td.keyword-friendlyName").html(friendlyName);
      $keywordRow.find("td.keyword-units").html(units);
      return $keywordRow;
   }

   function updateKeywordDomLine($keywordRow, acquisition, keyword, pluginInstance) {
      var keywordValue = "<span></span>";
      if (acquisition.value){
         try {
            //manage boolean keyword
            var $tdvalue = $keywordRow.find("td.keyword-value");
            
            if(keyword.type.toLowerCase() === "bool") {
               if(parseBool(acquisition.value) === true) {
                  keywordValue = "<input type=\"checkbox\" disabled readonly checked/>"
               } else {
                  keywordValue = "<input type=\"checkbox\" disabled readonly/>"
               }
            }
            else if(keyword.type.toLowerCase() === "enum") {
               var translatedEnumValue = $.t("plugins." + pluginInstance.type + ":enumerations." + keyword.typeInfo.name + ".values." + acquisition.value, { defaultValue:acquisition.value} );
               keywordValue = "<span>" + translatedEnumValue + "</span>";
            }
            else if(keyword.type.toLowerCase() === "json") {
               keywordValue = "<pre class=\"json-value-container\">" + library.json.prettyPrint(JSON.parse(acquisition.value)) + "</pre>";
            } else {
               if (acquisition.value !== "not-a-date-time")
                  keywordValue = "<span>" + acquisition.value + "</span>";
               else 
                  keywordValue = "<span>-</span>";
            }
         } catch (err) {
            keywordValue = "<span>" + acquisition.value + "</span>";
         } // If catch error, the string is not a JSON String

         var acquisitionDate = isNullOrUndefinedOrEmpty(acquisition.date) ? $.t("modals.dashboard.sub-windows.devices.noAcquisition") : DateTimeFormatter.isoDateToString(acquisition.date);
         var lastStateValue = "<span>" + acquisitionDate + "</span>";
      }

      $keywordRow.find("td.keyword-value").html(keywordValue);
      $keywordRow.find("td.keyword-update").html(lastStateValue);
   }
</script>